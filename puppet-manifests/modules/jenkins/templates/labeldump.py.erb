#!/usr/bin/env python

import base64
import json
import urllib2
import xml.etree.ElementTree as ET

jenkins_api_url = '<%= @jenkins_api_url || 'http://localhost:8080' %>'
jenkins_username = '<%= @jenkins_management_login %>'
jenkins_token = '<%= @jenkins_management_password %>'
destpath = '<%= @label_dumper_destpath || '/var/www/labels/' %>'

ua = urllib2.urlopen('%s/computer/api/json' % jenkins_api_url)
data = json.loads(ua.read())

for node in data['computer']:
    try:
        request = urllib2.Request('%s/computer/%s/config.xml' % (
            jenkins_api_url,
            node['displayName']))
        base64string = base64.encodestring('%s:%s' % (
            jenkins_username,
            jenkins_token)).replace('\n', '')
        request.add_header('Authorization', 'Basic %s' % base64string)
        configua = urllib2.urlopen(request)
        _element_tree = ET.fromstring(configua.read())
        node_labels = _element_tree.find('label').text or ''
    except:
        node_labels = ''

    labels = list(set((node_labels.split(' '))))
    labels = [x.strip() for x in labels]

    fp = open('%s/%s.labels' % (destpath, node['displayName']), 'w')
    fp.write(' '.join(labels))
    fp.close()
